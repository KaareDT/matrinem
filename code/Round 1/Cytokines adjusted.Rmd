---
title: "Cytokine analysis script - round 1 adjusted"
author: "Kaare"
date: "11th October 2022"    
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```

```{r load packages, include=FALSE}
library(readxl) 
library(tidyverse)
library(gt)
library(gtsummary)
library(broom)
library(rstatix)
library(knitr)
library(patchwork)
library(ggpubr)
```
# Introduction to script 
This script is useful for analysing cytokine expression from MSD Mesoscale assays. 
It is currently optimized for the 'Pro-inflammatory Vplex 10 Mouse kit', analysing the cytokines INFg, IL_10, IL_12p70, IL_1b, IL_2, IL_4,IL_5, IL_6, KCGRO, and TNFa. 

Required data structure is a wide tibble (column headers = variables, samples and values = rows).

This script is per default set to handle ileum and serum expression, although any tissue will work. This will just require resetting of the "tissue"-variable.

# Cytokines for experiment 1. - Tissue weight adjusted.

### Basic data structure and results table.

First you load the data and check the structure. Make sure cytokine concentrations are all numeric (<dbl>). If not, mutate non-numeric columns with mutate_if(is_character).  
```{r load data, echo=FALSE}
# Import dataset
cytokines <- read_excel("data/processed/cytokines.xlsx")

tissue_weight_destribution <- cytokines %>%   # run normality test on tissue weight
  filter(tissue == "ileum") %>% 
  filter(exp_number == "1") %>% 
  group_by(group) %>% 
  shapiro_test(tissue_weight_mg) 

# group  variable         statistic      p
#   <chr>  <chr>                <dbl>  <dbl>
# 1 AB-BF  tissue_weight_mg     0.917 0.404 
# 2 AB-FF  tissue_weight_mg     0.953 0.686 
# 3 CON-BF tissue_weight_mg     0.771 0.0138
# 4 CON-FF tissue_weight_mg     0.812 0.144 

#look at tissue weight distribution
cytokines %>% 
  filter(tissue == "ileum") %>% 
  filter(exp_number == "1") %>% 
  ggplot(aes(x = group, y = tissue_weight_mg, fill = group)) + 
  geom_boxplot() +
  geom_point()
```
<!-- Looks fine. Go ahead and  adjust-->

```{r adjust for tissue weight , echo=FALSE}
cytokines_adjusted <- cytokines %>% 
  pivot_longer(.,
               cols = INFg:TNFa ,
               names_to = "variables",
               values_to = "values"
  ) %>% 
  mutate(
    group = recode_factor(  #Change the order of the groups to desired plot order
      group,
      "CON-BF"= "CON-BF",
      "CON-FF" = "CON-FF",
      "AB-BF"= "AB-BF",
      "AB-FF"= "AB-FF"
      )) %>% 
  mutate(values = if_else(tissue == "ileum", values/tissue_weight_mg, values)) %>% #Adjust for tissue weight
  pivot_wider(
    id_cols = c(
      sample_id,exp_number, group, received_antibiotics,maternal_treatment, tissue,tissue_weight_mg),
    names_from = variables, 
    values_from = values)

#____Pivot longer____
cytokines_long <- cytokines_adjusted %>% 
  pivot_longer(.,
               cols = INFg:TNFa ,
               names_to = "variables",
               values_to = "values"
  )
```

Check for data distribution. 

```{r visualize data, eval=FALSE, include=FALSE}
#normality_check 
shapiro_failed <- cytokines_long %>% 
  filter(exp_number == 1) %>% 
  filter(tissue == "ileum") %>%
  filter(variables != "INFg") %>% 
  drop_na(values) %>% 
  group_by(variables, group) %>% 
  shapiro_test(values) %>% 
  filter(p < 0.05)

log10_shapiro_failed <- cytokines_long %>% 
  filter(exp_number == 1) %>% 
  filter(tissue == "ileum") %>%
  filter(variables != "INFg") %>% 
  drop_na(values) %>% 
  mutate(values = log10(values)) %>% 
  group_by(variables, group) %>% 
  shapiro_test(values) %>% 
  filter(p < 0.05)

#Density plots. Works
histogram <- cytokines_long %>% 
  filter(exp_number == 1) %>% 
  filter(tissue == "ileum") %>%
  filter(variables != "INFg") %>% 
  drop_na(values) %>% 
  ggplot(aes(x = values, fill = group)) + 
  geom_density() +
  facet_wrap(~ variables,
             scales = "free")

log10_histogram <- cytokines_long %>% 
  filter(exp_number == 1) %>% 
  filter(tissue == "ileum") %>%
  filter(variables != "INFg") %>% 
  drop_na(adjusted_values) %>% 
  ggplot(aes(x = log10(adjusted_values), fill = group)) + 
  geom_density() +
  facet_wrap(~ variables,
             scales = "free")

#Jitter plots. Works
jitter_plot <- cytokines_long %>% 
  filter(exp_number == 1) %>% 
  filter(tissue == "ileum") %>%
  #filter(variables != "INFg") %>% 
  drop_na(values) %>% 
  ggplot(aes(x = group, y = values, color = group)) +
  geom_jitter() +
  facet_wrap(~ variables,
             scales = "free") 

log10_jitter_plot <- cytokines_long %>% 
  filter(exp_number == 1) %>% 
  filter(tissue == "ileum") %>%
  filter(variables != "INFg") %>% 
  drop_na(values) %>% 
  mutate(adjusted_values = log10(values)) %>% 
  ggplot(aes(x = group, y = values, color = group)) +
  geom_jitter() +
  facet_wrap(~ variables,
             scales = "free") 
```

Set the tissue type to whatever tissue your data are extracted from, or that you want to analyze first.
```{r load data and set tissue type, include=FALSE}
#set tissue type
sample_tissue <- "ileum"
```

Below is a table of the mean levels of cytokines in `r sample_tissue` tissue for each of the experimental groups. 

The values will be displayed as mean + sd if normally distributed or median + IQR if not. An appropriate statistical test for differences will be performed (student-t for two, normally distributed groups, Anova for more than 2 groups, Kruskal wallis for non-normally distrubuted results.)

```{r advanced-cytokine-table}
#_____Currently non-normally distributed values are plotted as median (IQR)____# 
 #change statistics with help from here: https://www.danieldsjoberg.com/gtsummary/reference/tests.html 
#  add_p(everything() ~ "aov")  assuming equal variance

tbl1 <- cytokines %>% 
  filter(exp_number == "1") %>% 
  filter(tissue == sample_tissue) %>% 
  select(group,INFg:TNFa) %>% 
  tbl_summary(by = group,
              digits = everything() ~ c(2,1,1),
              missing = "no",
              include = !"INFg",
             # statistic = list(all_continuous() ~ "{mean} ({sd})")  #Un-comment this line to get mean+sd. 
             #%>%
statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  add_p() %>% 
  #modify_footnote("Exp. 1") %>% 
  modify_header(
    label ~ "Cytokines") %>% 
  modify_spanning_header((c("stat_1", "stat_2", "stat_3", "stat_4") ~ "Treatment groups (N total = {N})"))

  tbl1_gt <- tbl1 %>% 
  as_gt() %>%
  #tab_header(title = md("**Proinflammatory cytokines**")) %>%
  opt_align_table_header("center") %>% 
  # tab_options(heading.title.font.size = 20,
  #             heading.background.color = "lightgrey",
  #             ) %>% 
  tab_source_note(
    source_note = " * P-value indicates overall group differences"
  ) %>%
  tab_source_note(
    source_note = md("**Matrinem round 1**")
  ) %>%
  cols_width(label ~ px(100),
             stat_1 ~ px(150),
             stat_2 ~ px(150),
             stat_3 ~ px(150),
             stat_4 ~ px(150)) 
tbl1_gt


```
This table can be exported with the following code either to word, excel, pdf, html or image files. See the syntax of huxtable and flextable (?flextable). 
```{r ileum cytokine export, echo=TRUE, warning=FALSE}
tbl1_p <- tbl1 %>% 
  filter_p() %>% 
  as_tibble()
```

### Plots and regression models
First the data must be transformed to a long format (pivot longer). Mutate any new columns  with group treatments needed for the regression model (in this case MAT and FEED (experimental factors)). 

To see all the cytokine leves plotted run this code: 
```{r plots all cytokines, warning=FALSE}

plot_all_cytokines <- cytokines_long %>%
  filter(exp_number == "1") %>% 
  filter(tissue == sample_tissue) %>% 
  #filter(!variables %in% "INFg") %>%  #Exclude any cytokines not wanted in the plot
ggplot(aes(x = group, 
           y = values, 
           fill = group)) + 
  geom_boxplot() +
  facet_wrap(~variables, 
             scales = 'free', 
             nrow = 5,
             ncol = 2) +
  labs(title = "Levels of pro-inflammatory cytokines in the ileum",  # Change title, and axis names
       x = "",
       y = "Tissue conc. (pg/mg)",
       fill = "Groups") +
  theme_bw()+
  theme(                   # Change the appearance of labels
    plot.title = element_text(color="darkgrey", size=12, face="bold"),
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    #axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.title = element_text(face="bold"),   
    legend.position="bottom",
    legend.background = element_rect(fill="white")) + # Change legend box background color
  scale_fill_brewer(palette="Set1")

ggsave(filename = "exp1_cytokines.png",width = 2.14, height = 1.51, dpi = 300)

ggsave('../../exports/exp1_cytokines.png',
       plot_all_cytokines, scale =  width = 10, height = 16, units = "cm")
  
all_cytokines_patch <- plot_all_cytokines + plot_annotation (
  title = 'Cytokine expression',
   subtitle = 'All cytokines measured',
  tag_levels = 'A',
  caption = 'CON = Water, AB = Antibiotics, BF = Breast-Feeding, FF = Formula-Feeding',
  theme = theme(plot.title = element_text(hjust = 0.5, size=14, face="bold"),
                plot.subtitle = element_text(hjust = 0.5, face = "bold.italic"),
                plot.caption = element_text(hjust = 0.5, size=7,face = "bold")))
  
all_cytokines_patch
#ggsave('../../Results/Round 1/All Cytokines-boxplot.png',all_cytokines_patch)
```

Statistically significant group differences were observed for IL-6 (`r inline_text(tbl1, column = "p.value", variable = "IL_6")`), KCGRO (`r inline_text(tbl1, column = "p.value", variable = "KCGRO")`) and TNFa (`r inline_text(tbl1, column = "p.value", variable = "TNFa")`).

These cytokines are plottet below:
```{r}
#tbl1_p contains cytokines with significant changes

signif_cytokines <- cytokines_long %>%
  filter(tissue == sample_tissue) %>% 
  filter(variables %in% tbl1_p$`**Groups**`) %>%  #Exclude any cytokines not wanted in the plot
ggplot(aes(x = group, 
           y = values, 
           fill = group)) + 
  geom_boxplot() +
  stat_compare_means(aes(label = ..p.signif..),
                   method = "wilcox.test", ref.group = "CON-BF",
                   label.y.npc = 0.55) +
  stat_compare_means(
    aes(label = paste0("Kruskal-Wallis \n p = ", ..p.format..)),
    label.y.npc = 0.9,
    label.x.npc = 0.5) +
  facet_wrap(~variables, 
             scales = 'free', 
             nrow = 3,
             ncol = 3) +
  labs(title = "Levels of pro-inflammatory cytokines in the ileum", # Change title, and axis names
       #subtitle = "Statistically significant changes", 
       x = "",
       y = "Tissue conc. (pg/mg)",
       fill = "Groups") +
  theme_bw()+
  theme(                   # Change the appearance of labels
    plot.title = element_text(color="darkgrey", size=12, face="bold"),
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.title = element_text(face="bold"),   
    legend.position="bottom",
    legend.background = element_rect(fill="white")) + # Change legend box background color
  scale_fill_brewer(palette="Set1")
  
signif_cytokines_patch <- signif_cytokines + plot_annotation (
  title = 'Cytokine expression',
  subtitle = 'Statistically significant changes',
  tag_levels = 'A',
  caption = 'CON = Water, AB = Antibiotics, BF = Breast-Feeding, FF = Formula-Feeding. \n
  Pairwise comparisons with CON-BF using wilcoxon test',
  theme = theme(plot.title = element_text(hjust = 0.5, size=14, face="bold"),
                plot.subtitle = element_text(hjust = 0.5, face = "bold.italic"),
                plot.caption = element_text(hjust = 0.5, size=7,face = "bold")))
signif_cytokines_patch
#ggsave('../../Results/Round 1/Significant Cytokines-boxplot.png',signif_cytokines_patch)
```


A regression model of the effects of type of feed and antibiotics treatment
```{r echo=FALSE, warning=FALSE}
#### Make regression model on long format
linear_reg_model <- cytokines_long %>% 
  filter(tissue == sample_tissue) %>% 
  group_by(variables) %>% 
  do(lm(data = ., values ~ MAT+FEED+MAT*FEED) %>% tidy)  %>% filter(term!='(Intercept)')

linear_reg_model %>%  
  select(-statistic) %>% 
  kable(., caption = 'Effect of treatment factors on cytokine expression levels', digits = 3)

#### Make regression model on one variable
# reg_model_1 <- cytokines_long %>% 
#   filter(tissue == sample_tissue) %>% 
#   filter(variables %in% "TNFa") %>% 
#   lm(data =., values ~ FEED + MAT)
# summary(reg_model_1)
```


**The conclusion** is that many of the cytokines show an interaction effect of the two treatment parameters
