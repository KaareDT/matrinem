---
title: "Cytokine analysis script - round 3"
author: "Kaare"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```

```{r load packages, include=FALSE}
library(readxl) 
library(tidyverse)
library(gt)
library(gtsummary)
library(broom)
library(rstatix)
library(knitr)
library(patchwork)
library(ggpubr)
```

# Introduction to script

This script is useful for analyzing cytokine expression from MSD Mesoscale assays. It is currently optimized for the 'Pro-inflammatory Vplex 10 Mouse kit', analysing the cytokines INFg, IL_10, IL_12p70, IL_1b, IL_2, IL_4,IL_5, IL_6, KCGRO, and TNFa.

Required data structure is a wide tibble (column headers = variables, samples and values = rows).

This script is per default set to handle ileum and serum expression, although any tissue will work. This will just require resetting of the "tissue"-variable.

# Cytokines for experiment 2.

### Basic data structure and results table.

First you load the data and check the structure. Make sure cytokine concentrations are all numeric (<dbl>). If not, mutate non-numeric columns with mutate_if(is_character).

```{r load data, echo=FALSE}
# Import dataset
#cytokines <- read_excel("../../Data/RawData/cytokines_round_1_r.xlsm")
cytokines <- read_excel("data/processed//cytokines.xlsx")
glimpse(cytokines)
```


```{r load data and set tissue type, include=FALSE}
#set tissue type
sample_tissue <- "ileum"
study_round <- "3"
```


```{r load data, echo=FALSE}
cytokines %>%   # run normality test on tissue weight
   filter(exp_number == 3) %>% 
  filter(tissue == sample_tissue) %>%
  group_by(type_of_feed) %>% 
  shapiro_test(tissue_weight_mg) 

# group    variable         statistic      p
 # <chr>    <chr>                <dbl>  <dbl>
# CON-BF   tissue_weight_mg     0.833 0.197 
#GENTA-BF tissue_weight_mg     0.748 0.0120
#VANCO-BF tissue_weight_mg     0.833 0.0861
#look at tissue weight distribution

cytokines %>%       #Weight of tissue samples
   filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>%
  ggplot(aes(x = group, y = tissue_weight_mg, fill = group)) + 
  geom_boxplot() +
  geom_point() +
  labs(
    title = "Weight of intestinal samples",
      x = "",
       y = "Tissue weight (mg)",
       fill = "Groups",
       caption = "Matrinem round 3") +
  theme_bw()

cytokines %>%   # run normality test on tissue weight
   filter(exp_number == 3) %>% 
  filter(tissue == sample_tissue) %>%
  group_by(type_of_feed) %>% 
  summarise(mean = mean(tissue_weight_mg),
            sd = sd(tissue_weight_mg))


cytokines %>%   # run normality test on tissue weight
   filter(exp_number == 3) %>% 
  filter(tissue == sample_tissue) %>%
  lm(tissue_weight_mg ~ type_of_feed,.) %>% 
  summary()



```

```{r}
cytokines_unadjusted <- cytokines %>% 
  pivot_longer(.,
               cols = INFg:TNFa ,
               names_to = "variables",
               values_to = "values"
  ) %>% 
  mutate(
    group = recode_factor(  #Change the order of the groups to desired plot order
      group,
      "CON-BF"= "CON-BF",
      "CON-FF" = "CON-FF",
      "AB-BF"= "AB-BF",
      "AB-FF"= "AB-FF"
      )) %>% 
  #mutate(adjusted_values = if_else(tissue == "ileum", values/tissue_weight_mg, values)) %>% #Adjust for tissue weight
  pivot_wider(
    id_cols = c(
      sample_id,exp_number, group, received_antibiotics,maternal_treatment, tissue,tissue_weight_mg),
    names_from = variables, 
    values_from = values)

#____Pivot longer____
cytokines_long_unadjusted <- cytokines %>% 
  pivot_longer(.,
               cols = INFg:TNFa ,
               names_to = "variables",
               values_to = "values"
  )

```

<!-- Looks fine. Go ahead and  adjust-->


```{r}
cytokines_adjusted <- cytokines %>% 
  pivot_longer(.,
               cols = INFg:TNFa ,
               names_to = "variables",
               values_to = "values"
  ) %>% 
  mutate(
    group = recode_factor(  #Change the order of the groups to desired plot order
      group,
      "CON-BF"= "CON-BF",
      "CON-FF" = "CON-FF",
      "AB-BF"= "AB-BF",
      "AB-FF"= "AB-FF"
      )) %>% 
  mutate(adjusted_values = if_else(tissue == "ileum", values/tissue_weight_mg, values)) %>% #Adjust for tissue weight
  pivot_wider(
    id_cols = c(
      sample_id,exp_number, group, received_antibiotics,maternal_treatment, tissue,tissue_weight_mg),
    names_from = variables, 
    values_from = adjusted_values)

#____Pivot longer____
cytokines_long_adjusted <- cytokines %>% 
  pivot_longer(.,
               cols = INFg:TNFa ,
               names_to = "variables",
               values_to = "adjusted_values"
  )

```


```{r load data and set tissue type, include=FALSE}
#set tissue type
sample_tissue <- "ileum"
study_round <- "3"
```

Below is a table of the mean levels of cytokines in `r sample_tissue` tissue for each of the experimental groups.

The values will be displayed as mean + sd if normally distributed or median + IQR if not. An appropriate statistical test for differences will be performed (student-t for two, normally distributed groups, Anova for more than 2 groups, Kruskal wallis for non-normally distrubuted results.)

```{r}
tbl1 <- cytokines %>% 
  filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>% 
  select(group,INFg:TNFa) %>% 
  tbl_summary(by = group,
              digits = everything() ~ c(2,1,1),
              missing = "no") %>%
  add_p() %>% 
  modify_header(
    label ~ "**Groups**:")
  #modify_spanning_header((c("stat_1", "stat_2", "stat_3","stat_4", "stat_5", "stat_6") ~ "Matrinem round 3 (N total = {N})"))

tbl1_gt <- tbl1 %>% 
 as_gt() %>%
  tab_header(title = md("**Tissue concentrations of pro-inflammatory cytokines** *(pg/ml)*")) %>%
  opt_align_table_header("center") %>% 
  tab_options(heading.title.font.size = 20,
              heading.background.color = "lightgrey",
              ) %>% 
  tab_source_note(
    source_note = " * P-value indicates overall group differences"
  ) %>%
   tab_source_note(
    source_note = "Matrinem round 3"
  ) %>%
  cols_width(label ~ px(100),
             stat_1 ~ px(150),
             stat_2 ~ px(150),
             stat_3 ~ px(150),
             stat_4 ~ px(150),
             stat_5 ~ px(150),
             stat_6 ~ px(150)) 
tbl1_gt
# Save and export files
# tbl1 %>%  #Save as excel file.
#   as_hux_table() %>%
#   huxtable::quick_xlsx(., file = "../Results/Round 1/ileum-cytokines.xlsx")
# 
# tbl1 %>% #Save as image file.
# as_flex_table() %>%
#   flextable::save_as_image(path = "../../Results/Round 2/ileum_cytokines_table.png",webshot = "webshot")
```

This table can be exported with the following code either to word, excel, pdf, html or image files. See the syntax of huxtable and flextable (?flextable).

```{r ileum cytokine export, echo=TRUE, warning=FALSE}
tbl1_p <- tbl1 %>%
  filter_p() %>% 
  as_tibble()
```

### Plots and regression models

First the data must be transformed to a long format (pivot longer). Mutate any new columns with group treatments needed for the regression model (in this case MAT and FEED (experimental factors)).

```{r long format, echo=FALSE}
cytokines_long <- cytokines %>% 
  filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>%
  pivot_longer(.,
               cols = INFg:TNFa ,
               names_to = "variables",
               values_to = "values"
  ) %>% 
  drop_na(
    values) %>% 
  # mutate(MAT = ifelse(str_detect(group,'AB'),'AB',
  #                                 ifelse(str_detect(group,'CON'),'CON', "miss")),
  #        FEED = ifelse(str_detect(group,'FF'),'FF',
  #                                 ifelse(str_detect(group,'BF'),'BF', "miss"))) %>% 
  mutate(
    group = recode_factor(  #Change the order of the groups to desired plot order
      group,
      "CON-BF"= "CON-BF",
      "CON-FF" = "CON-FF",
      "GENTA-BF"= "GENTA-BF",
      "GENTA-FF"= "GENTA-FF",
      "VANCO-BF"= "VANCO-BF",
      "VANCO-FF"= "VANCO-FF",
      ))

head(cytokines_long)
      
```

To see all the cytokine leves plotted run this code:

```{r plots all cytokines, warning=FALSE}
plot_all_cytokines <- cytokines_long %>%
  #filter(!variables %in% "INFg") %>%  #Exclude any cytokines not wanted in the plot
ggplot(aes(x = group, 
           y = values, 
           fill = group)) + 
  geom_boxplot() +
  facet_wrap(~variables, 
             scales = 'free', 
             nrow = 5,
             ncol = 2) +
  labs(title = "Levels of pro-inflammatory cytokines in the ileum",  # Change title, and axis names
       x = "",
       y = "Tissue conc.",
       fill = "Groups",
       caption = "Matrinem round 3") +
  theme_bw()+
  theme(                   # Change the appearance of labels
    plot.title = element_text(color="darkgrey", size=12, face="bold"),
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.title = element_text(face="bold"),   
    legend.position="bottom",
    legend.background = element_rect(fill="lightgrey"), # Change legend box background color
    plot.caption = element_text(color = "darkgrey", size=5)) + 
  scale_fill_brewer(palette="Set1")
  
all_cytokines_patch <- plot_all_cytokines + plot_annotation (
  title = 'Cytokine expression',
   subtitle = 'All cytokines measured',
  tag_levels = 'A',
  caption = 'CON = Water, GENTA = Gentamicin,  VANCO = Vancomycin  \n
   BF = Breast-Feeding, FF = Formula-Feeding',
  theme = theme(plot.title = element_text(hjust = 0.5, size=14, face="bold"),
                plot.subtitle = element_text(hjust = 0.5, face = "bold.italic"),
                plot.caption = element_text(hjust = 0.5, size=7,face = "bold")))
  
all_cytokines_patch
#ggsave('../../Results/Round 1/All Cytokines-boxplot.png',all_cytokines_patch)
```

Statistically significant group differences were observed for \`r ifelse([tbl1_p$Cytokines] > 0, tbl1_1$Cytokines, "no cytokines)\`\`

These cytokines are plottet below:

```{r}
#tbl1_p contains cytokines with significant changes
my_comparisons <- list( c("CON-BF", "CON-FF"), c("GENTA-BF", "GENTA-FF"))

signif_cytokines <- cytokines_long %>%
  filter(variables %in% c("IL-2","IL-6", "KCGRO")) %>% 
  filter(values > 0.5) %>% #Exclude any cytokines not wanted in the plot
ggplot(aes(x = group, 
           y = values, 
           fill = group)) + 
  geom_boxplot() +
  stat_compare_means(comparisons = my_comparisons, label.y.npc =  c(0.20, 0.15), method = "wilcox.test") +
  facet_wrap(~variables, 
             scales = 'free') +
  labs(title = "Levels of pro-inflammatory cytokines in the ileum", # Change title, and axis names
       #subtitle = "Statistically significant changes", 
       x = "",
       y = "Cytokine concentration (pg/ml)",
       fill = "Groups") +
  theme_bw()+
  theme(                   # Change the appearance of labels
    plot.title = element_text(color="darkgrey", size=12, face="bold"),
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    #axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.title = element_text(face="bold"),   
    legend.position="bottom",
    legend.background = element_rect(fill="white")) + # Change legend box background color
  scale_fill_brewer(palette="Set1")
  
signif_cytokines_patch <- signif_cytokines + plot_annotation (
  #title = 'Cytokine expression',
  #subtitle = 'Statistically significant changes',
  #tag_levels = 'A',
  caption = 'CON = Water, AB = Antibiotics, BF = Breast-Feeding, FF = Formula-Feeding. \n
  Pairwise comparisons using wilcoxon test.',
  theme = theme(plot.title = element_text(hjust = 0.5, size=14, face="bold"),
                plot.subtitle = element_text(hjust = 0.5, face = "bold.italic"),
                plot.caption = element_text(hjust = 0.5, size=7,face = "bold")))
signif_cytokines_patch
#ggsave('../../Results/Round 1/Significant Cytokines-boxplot.png',signif_cytokines_patch)
```

```{r}
my_comparisons <- list( c("CON-BF", "CON-FF"), c("GENTA-BF", "GENTA-FF"), c("VANCO-BF", "VANCO-FF"), c("GENTA-FF", "VANCO-FF"))

signif_cytokines_plot <- cytokines_long %>%    #____Normal values_____#
filter(variables %in% tbl1_p$`**Groups**:`) %>% 
  ggplot(aes(x = group, 
           y = values, 
           fill = group)) + 
  geom_boxplot() +
  geom_point() +
  #coord_cartesian(ylim = c(1.5, 16)) + 
  stat_compare_means(comparisons = my_comparisons, label.y.npc = c(0.30, 0.30, 0.30, 0.50), method = "wilcox.test")+
  # stat_compare_means(aes(label = paste0("Kruskal-Wallis \n p = ", ..p.format..)),
  #   label.y.npc = 0.75,
  #   label.x.npc = 0.55) +
  labs( # Change title, and axis names
       x = "",
       y = "Cytokine concentration (pg/ml)",
       fill = "Groups",
       caption = "Matrinem round 3") +
  theme_bw()+
  theme(                   # Change the appearance of labels
    plot.title = element_text(color="darkgrey", size=12, face="bold"),
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    #axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.title = element_text(face="bold"),   
    legend.position="bottom",
    legend.background = element_rect(fill="lightgrey"),#Change legend box background color
    plot.caption = element_text(color = "darkgrey", size=5)) + 
  scale_fill_brewer(palette="Set1")
  
cytokine_patch <- signif_cytokines_plot + plot_annotation (
  title = 'Proinflammatory Cytokines',
   #subtitle = 'All fitc measured',
  #tag_levels = 'A',
  caption = 'CON = Water, BF = Breast-Feeding, GENTA = Gentamicin,  VANCO = Vancomycin,  \n
  Pariwise comparisons = Wilcoxon test.',
  theme = theme(plot.title = element_text(hjust = 0.5, size=14, face="bold"),
                plot.subtitle = element_text(hjust = 0.5, face = "bold.italic"),
                plot.caption = element_text(hjust = 0.5, size=7,face = "bold")))
  
cytokine_patch
```



A regression model of the effects of type of feed and antibiotics treatment

```{r echo=FALSE, warning=FALSE}
#### Make regression model on long format
linear_reg_model <- cytokines_long %>% 
  group_by(variables) %>% 
  do(lm(data = ., values ~ MAT+FEED+MAT*FEED) %>% tidy)  %>% filter(term!='(Intercept)')

linear_reg_model %>%  
  select(-statistic) %>% 
  kable(., caption = 'Effect of treatment factors on cytokine expression levels', digits = 3)

#### Make regression model on one variable
# reg_model_1 <- cytokines_long %>% 
#   filter(tissue == sample_tissue) %>% 
#   filter(variables %in% "TNFa") %>% 
#   lm(data =., values ~ FEED + MAT)
# summary(reg_model_1)
```

**The conclusion** is that many of the cytokines show an interaction effect of the two treatment parameters
