---
title: "Cytokine analysis script - round 3 adjusted"
author: "Kaare"
date: "11th October 2022"    
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```

```{r load packages, include=FALSE}
library(readxl) 
library(tidyverse)
library(gt)
library(gtsummary)
library(broom)
library(rstatix)
library(knitr)
library(patchwork)
library(ggpubr)
```
# Introduction to script 
This script is useful for analysing cytokine expression from MSD Mesoscale assays. 
It is currently optimized for the 'Pro-inflammatory Vplex 10 Mouse kit', analysing the cytokines INFg, IL_10, IL_12p70, IL_1b, IL_2, IL_4,IL_5, IL_6, KCGRO, and TNFa. 

Required data structure is a wide tibble (column headers = variables, samples and values = rows).

This script is per default set to handle ileum and serum expression, although any tissue will work. This will just require resetting of the "tissue"-variable.

# Cytokines for experiments  - Tissue weight adjusted.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```

```{r load data, echo=FALSE}
# Import dataset
cytokines <- read_excel("data/processed/cytokines.xlsx")
```

Set the tissue type and experimental round here: 

```{r load data and set tissue type, include=FALSE}
#set tissue type
sample_tissue <- "ileum"
study_round <- "3"
```

```{r load data, echo=FALSE}
cytokines %>%   # run normality test on tissue weight
   filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>%
  filter(group != "VANCO-BF") %>% 
  group_by(type_of_feed) %>% 
  shapiro_test(tissue_weight_mg) 

# group    variable         statistic      p
 # <chr>    <chr>                <dbl>  <dbl>
# CON-BF   tissue_weight_mg     0.833 0.197 
#GENTA-BF tissue_weight_mg     0.748 0.0120
#VANCO-BF tissue_weight_mg     0.833 0.0861
#look at tissue weight distribution

cytokines %>%       #Weight of tissue samples
   filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>%
  ggplot(aes(x = group, y = tissue_weight_mg, fill = group)) + 
  geom_boxplot() +
  geom_point() +
  labs(
    title = "Tissue weight of intestinal samples, experiment 3"
  )
```
<!-- Looks fine. Go ahead and  adjust-->

```{r adjust for tissue weight , echo=FALSE}
cytokines_adjusted <- cytokines %>% 
  pivot_longer(.,
               cols = INFg:TNFa ,
               names_to = "variables",
               values_to = "values"
  ) %>% 
  mutate(values = values/tissue_weight_mg) %>% #Adjust for tissue weight
  pivot_wider(
    id_cols = c(
      sample_id,exp_number, group, received_antibiotics,maternal_treatment, type_of_feed, tissue,tissue_weight_mg),
    names_from = variables, 
    values_from = values)

#____Pivot longer____
cytokines_long_adjusted <- cytokines_adjusted %>% 
  pivot_longer(.,
               cols = INFg:TNFa ,
               names_to = "variables",
               values_to = "values"
  )
```



Check for data distribution. 

```{r visualize data, eval=FALSE, include=FALSE}
cytokines_long %>%                       #normality_check  of cytokine distributions
  filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>%
  filter(group != "VANCO-BF") %>% 
  drop_na(values) %>% 
  group_by(variables, group) %>% 
  shapiro_test(values) %>% 
  filter(p < 0.05)

#Non-normal distributions: 
#  group    variables variable statistic      p
#  <fct>    <chr>     <chr>        <dbl>  <dbl>
# VANCO-BF IL-1b     values       0.795 0.0363
# GENTA-BF IL-4      values       0.777 0.0240


#log10 transformed shapiro_test - failed variables
cytokines_long %>% 
 filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>%
  filter(variables != "INFg") %>% 
  drop_na(values) %>% 
  mutate(values = log10(values)) %>% 
  group_by(variables, group) %>% 
  shapiro_test(values) %>% 
  filter(p < 0.05)

#  group    variables variable statistic       p
#  <fct>    <chr>     <chr>        <dbl>   <dbl>
# VANCO-BF IL-1b     values       0.727 0.00728     # transformation helped.

#Density plots to show distribution of cytokines
histogram <- cytokines_long %>% 
   filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>%
  filter(group != "VANCO-BF") %>% 
  drop_na(values) %>% 
  ggplot(aes(x = values, fill = group)) + 
  geom_histogram() +
  facet_wrap(~ variables, ncol = 5,
             scales = "free")

log10_histogram <- cytokines_long %>% 
   filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>%
  #filter(variables != "INFg") %>% 
  drop_na(values) %>% 
  ggplot(aes(x = log10(values), fill = group)) + 
  geom_density() +
  facet_wrap(~ variables, ncol = 2,
             scales = "free")

#Jitter plots. Works
jitter_plot <- cytokines_long %>% 
   filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>%
  #filter(variables != "INFg") %>% 
  drop_na(values) %>% 
  ggplot(aes(x = group, y = values, color = group)) +
  geom_jitter() +
  facet_wrap(~ variables,
             scales = "free") 

log10_jitter_plot <- cytokines_long %>% 
   filter(exp_number == study_round) %>% 
  filter(tissue == sample_tissue) %>%
  filter(variables != "INFg") %>% 
  drop_na(values) %>% 
  mutate(adjusted_values = log10(values)) %>% 
  ggplot(aes(x = group, y = values, color = group)) +
  geom_jitter() +
  facet_wrap(~ variables,
             scales = "free") 
```

Below is a table of the mean levels of cytokines in `r sample_tissue` tissue for each of the experimental groups. 

The values will be displayed as mean + sd if normally distributed or median + IQR if not. An appropriate statistical test for differences will be performed (student-t for two, normally distributed groups, Anova for more than 2 groups, Kruskal wallis for non-normally distrubuted results.)

```{r advanced-cytokine-table}
#_____Currently non-normally distributed values are plotted as median (IQR)____# 
 #change statistics with help from here: https://www.danieldsjoberg.com/gtsummary/reference/tests.html 
#  add_p(everything() ~ "aov")  assuming equal variance

tbl1 <- cytokines_adjusted %>% 
  filter(exp_number == "3") %>% 
  filter(tissue == sample_tissue) %>% 
  filter(group != "VANCO-BF") %>% 
  select(group,INFg:TNFa) %>% 
  tbl_summary(by = group,
              digits = everything() ~ c(2,1,1),
              missing = "no",
              #type = all_continuous() ~ "continuous2",
              statistic = all_continuous() ~ #c("{mean} ({sd})",         
                                     "{median} ({p25}, {p75})") %>%
  add_p() %>% 
  #modify_footnote("Exp. 1") %>% 
  modify_header(
    label ~ "Cytokines")
  #modify_spanning_header((c("stat_1", "stat_2", "stat_3", "stat_4") ~ "Experiment 1 (N total = {N})")) %>% 


  tbl1_gt <- tbl1 %>% 
  as_gt() %>%
  tab_header(title = md("**Tissue concentraions of proinflammatory cytokines** *(pg/ml/mg tissue)*")) %>%
  opt_align_table_header("center") %>% 
   tab_options(heading.title.font.size = 20,
               heading.background.color = "lightgrey",
               ) %>% 
  tab_source_note(
    source_note = " *P-value indicates overall group differences"
  ) %>%
     tab_source_note(
    source_note = "Matrinem Experiment 3"
  ) %>%
  cols_width(label ~ px(200),
             stat_1 ~ px(150),
             stat_2 ~ px(200),
             stat_3 ~ px(200),
             stat_4 ~ px(200),
             stat_5 ~ px(200)) 
tbl1_gt


```
This table can be exported with the following code either to word, excel, pdf, html or image files. See the syntax of huxtable and flextable (?flextable). 
```{r ileum cytokine export, echo=TRUE, warning=FALSE}
tbl1_p <- tbl1 %>% 
  filter_p() %>% 
  as_tibble()
```

### Plots and regression models
First the data must be transformed to a long format (pivot longer). Mutate any new columns  with group treatments needed for the regression model (in this case MAT and FEED (experimental factors)). 

To see all the cytokine leves plotted run this code: 
```{r plots all cytokines, warning=FALSE}

plot_all_cytokines <- cytokines_long_adjusted %>%
  filter(exp_number == "1") %>% 
  filter(tissue == sample_tissue) %>% 
  filter(!variables %in% c("INFg", "IL-12p70")) %>%  #Exclude any cytokines not wanted in the plot
ggplot(aes(x = group, 
           y = values, 
           fill = group)) + 
  geom_boxplot() +
  facet_wrap(~variables, 
             scales = 'free', 
             nrow = 5,
             ncol = 2) +
  labs(title = "Levels of pro-inflammatory cytokines in serum",  # Change title, and axis names
       x = "",
       y = "Serum conc. (pg/ml)",
       fill = "Groups") +
  theme_bw()+
  theme(                   # Change the appearance of labels
    plot.title = element_text(color="darkgrey", size=12, face="bold"),
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    #axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.title = element_text(face="bold"),   
    legend.position="bottom",
    legend.background = element_rect(fill="white")) + # Change legend box background color
  scale_fill_brewer(palette="Set1")

#ggsave('../../exports/exp1_cytokines.png',
     #  plot_all_cytokines,  width = 400, height = 600, units = "px")
  
all_cytokines_patch <- plot_all_cytokines + plot_annotation (
  #title = 'Cytokine expression',
   #subtitle = 'All cytokines measured',
  #tag_levels = 'A',
  caption = 'CON = Water, AB = Antibiotics, BF = Breast-Feeding, FF = Formula-Feeding',
  theme = theme(plot.title = element_text(hjust = 0.5, size=14, face="bold"),
                plot.subtitle = element_text(hjust = 0.5, face = "bold.italic"),
                plot.caption = element_text(hjust = 0.5, size=7,face = "bold")))
  
all_cytokines_patch
#ggsave('../../Results/Round 1/All Cytokines-boxplot.png',all_cytokines_patch)
```

Statistically significant group differences were observed for IL-6 (`r inline_text(tbl1, column = "p.value", variable = "IL_6")`), KCGRO (`r inline_text(tbl1, column = "p.value", variable = "KCGRO")`) and TNFa (`r inline_text(tbl1, column = "p.value", variable = "TNFa")`).

These cytokines are plottet below:
```{r}
#tbl1_p contains cytokines with significant changes

signif_cytokines <- cytokines_long %>%
  filter(exp_number == "1") %>% 
  filter(tissue == sample_tissue) %>% 
  filter(variables %in% tbl1_p$Cytokines) %>%  #Exclude any cytokines not wanted in the plot
ggplot(aes(x = group, 
           y = values, 
           fill = group)) + 
  geom_boxplot() +
  stat_compare_means(aes(label = ..p.signif..),
                   method = "wilcox.test", ref.group = "CON-BF",
                   label.y.npc = 0.55) +
  stat_compare_means(
    aes(label = paste0("Global p = ", ..p.format..)),
    label.y.npc = 0.75,
    label.x.npc = 0.3) +
  facet_wrap(~variables, 
             scales = 'free', 
             nrow = 3,
             ncol = 3) +
  labs(title = "Levels of pro-inflammatory cytokines in the ileum", # Change title, and axis names
       #subtitle = "Statistically significant changes", 
       x = "",
       y = "Tissue conc. (pg/mg)",
       fill = "Groups") +
  theme_bw()+
  theme(                   # Change the appearance of labels
    plot.title = element_text(color="darkgrey", size=12, face="bold"),
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.title = element_text(face="bold"),   
    legend.position="bottom",
    legend.background = element_rect(fill="white")) + # Change legend box background color
  scale_fill_brewer(palette="Set1")
  
signif_cytokines_patch <- signif_cytokines + plot_annotation (
  #title = 'Cytokine expression',
  #subtitle = 'Statistically significant changes',
  #tag_levels = 'A',
  caption = 'CON = Water, AB = Antibiotics, BF = Breast-Feeding, FF = Formula-Feeding. \n
  Pairwise comparisons against CON-BF, wilcoxon test',
  theme = theme(plot.title = element_text(hjust = 0.5, size=14, face="bold"),
                plot.subtitle = element_text(hjust = 0.5, face = "bold.italic"),
                plot.caption = element_text(hjust = 0.5, size=7,face = "bold")))
signif_cytokines_patch
#ggsave('../../Results/Round 1/Significant Cytokines-boxplot.png',signif_cytokines_patch)
```


A regression model of the effects of type of feed and antibiotics treatment
```{r echo=FALSE, warning=FALSE}
#### Make regression model on long format
linear_reg_model <- cytokines_long %>% 
  filter(tissue == sample_tissue) %>%
  filter(exp_number == study_round) %>% 
  group_by(variables) %>% 
  do(lm(data = ., values ~ maternal_treatment+type_of_feed +maternal_treatment*type_of_feed) %>% tidy)  %>% filter(term!='(Intercept)')

linear_reg_model %>%  
  select(-statistic) %>% 
  filter(p.value < 0.05) %>% 
  kable(., caption = 'Effect of treatment factors on cytokine expression levels', digits = 3)

#### Make regression model on one variable
# reg_model_1 <- cytokines_long %>% 
#   filter(tissue == sample_tissue) %>% 
#   filter(variables %in% "TNFa") %>% 
#   lm(data =., values ~ FEED + MAT)
# summary(reg_model_1)
```


**The conclusion** is that many of the cytokines show an interaction effect of the two treatment parameters
