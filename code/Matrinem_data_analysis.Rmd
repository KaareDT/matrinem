---
title: "Results section"
author: "Kaare"
date: "6/16/2022"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#setwd(dir = "../../2022_matrinem_thesis/")
```

```{r loading libraries, message=FALSE}
library(readxl)
library(tidyverse)
library(broom)
library(ggpubr)
#library(AICcmodavg)
library(visdat)
library(rstatix)
library(gt)
library(gtsummary)
library(patchwork)
library(jtools)
```

### PreExp 1 - Feasibility Study

#Load in the data
```{r exp1-weight, include=FALSE}
#____Load overview of sample IDs______ 
pups <- read_excel("data/processed/weight_development.xlsx") 

#____ Separate into experimental rounds ____#
preexp_1 <- pups %>% 
  filter(exp_number == "1")

exp1_survived <- preexp_1 %>% 
  filter(!is.na(bodyweight_baseline_plus_48h)) %>% 
  nrow()
#____ ____#
```

```{r exp1-groups}
#____Separate into groups ______ 
AB_FF <- nrow(preexp_1 %>% 
  filter(group2 == "AB-FF")) 

AB_BF <- nrow(preexp_1 %>% 
  filter(group2 == "AB-BF")) 

CON_FF <- nrow(preexp_1 %>% 
  filter(group2 == "CON-FF")) 

CON_BF <- nrow(preexp_1 %>% 
  filter(group2 == "CON-BF")) 
#____ ____#

```

Survival rate: `r exp1_survived` of `r nrow(preexp_1)`(`r (exp1_survived / nrow(preexp_1))*100`%)

```{r}
#__________Load in cytokine data for all experiments________
cytokines_1 <- read_excel(path = "data/processed/cytokines.xlsx") %>%  
  filter(exp_number == 1) %>% 
  filter(tissue == "ileum") %>% 
  mutate(
    group = recode_factor(  #Change the order of the groups to desired plot order
      group,
      "CON-BF"= "CON-BF",
      "CON-FF" = "CON-FF",
      "AB-BF"= "AB-BF",
      "AB-FF"= "AB-FF"
      ))
#___________________________________________________________


#__________ Pivot longer  ____________
cytokines_1_long <- cytokines_1 %>% 
  pivot_longer(cols = INFg:TNFa, 
               names_to = "cytokines", 
               values_to = "cytokine_concentration") %>% 
  drop_na(cytokine_concentration)
#___________________________________________________________
```

`r nrow(preexp_1)` mice were born to 6 different mothers. Of these 32 survived and were included in the analysis. After fine-tuning the feeding method we we able to successfully feed all surviving (32) mice every 3 hours for 2 days (48 hours).

##### Will MAT and FF affect levels of inflammatory cytokines in ileum tissue?

```{r}
#___________ Check cytokine distribution for normality, filter significant ones _____________________
normality_check <- cytokines_1_long %>% 
  group_by(cytokines) %>% 
  shapiro_test(cytokine_concentration) 
#___________________________________________________________

non_normal_cytokines <- normality_check %>% 
  filter(p < 0.05) 

#___________ Jitterplot of all non-normally distributed cytokines _____________________
normality_plot <- cytokines_1_long %>%
  filter(cytokines %in% non_normal_cytokines$cytokines ) %>% 
  ggplot(aes(x = group, 
             y = cytokine_concentration,
             color = group)) + 
  geom_jitter() +
  facet_wrap(~ cytokines,
             scales = "free") + 
  labs(title = "Non-normally distributed cytokines (Shapiro-Wilk Normality Test, p < 0.05)",
       y = "Concentration of cytokine in tissue (pg/mL)",
       x = "") +
  theme_bw()
#___________________________________________________________

#___________ Jitterplot of all non-normally distributed cytokines _____________________
normality_result_1 <- normality_check %>% 
  knitr::kable(caption = "Normallity check of cytokine distribution (Shapiro-Wilk Normality Test, p < 0.05)")
#___________________________________________________________

names_of_cytokines <-unique(cytokines_1_long$cytokines)
```

`r nrow(cytokines_1)` samples were available for analysis of concentrations of the proinflammatory cytokines `r names_of_cytokines`. Concentrations were measured in 1-cm sections of proximal/distal ileum tissue using MSD Mesoscale Kits.

```{r}
tbl1 <- cytokines_1 %>% 
  select(group,INFg:TNFa) %>% 
  tbl_summary(by = group,
              digits = everything() ~ c(2,1,1),
              missing = "no",
              include = !"INFg") %>%
  add_p() %>% 
  modify_header(
    label ~ "Cytokines") %>% 
  modify_spanning_header((c("stat_1", "stat_2", "stat_3", "stat_4") ~ "Total number of mice analyzed = {N}"))

  tbl1_gt <- tbl1 %>% 
  as_gt() %>%
  tab_header(title = md("**Proinflammatory cytokines**")) %>%
  opt_align_table_header("center") %>% 
  tab_options(heading.title.font.size = 20,
              heading.background.color = "lightgrey",
              ) %>% 
  tab_source_note(
    source_note = " * P-value indicates overall group differences"
  ) %>%
  tab_source_note(
    source_note = md("**Matrinem round 1**")
  ) %>%
  cols_width(label ~ px(100),
             stat_1 ~ px(150),
             stat_2 ~ px(150),
             stat_3 ~ px(150),
             stat_4 ~ px(150))
```

The concentrations of the various cytokines are shown in the table below:

```{r, echo=FALSE}
tbl1_gt

```

```{r plots all cytokines, warning=FALSE}
plot_all_cytokines <- cytokines_1_long %>%
  #filter(!variables %in% "INFg") %>%  #Exclude any cytokines not wanted in the plot
ggplot(aes(x = group, 
           y = cytokine_concentration, 
           fill = group)) + 
  geom_boxplot() +
  facet_wrap(~cytokines, 
             scales = 'free', 
             nrow = 3,
             ncol = 4) +
  labs(title = "Levels of pro-inflammatory cytokines in the ileum",  # Change title, and axis names
       x = "",
       y = "Tissue conc. (pg/mL)",
       fill = "Groups") +
  theme_bw() +
  theme(                   # Change the appearance of labels
    plot.title = element_text(color="darkgrey", size=12, face="bold"),
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.title = element_text(face="bold"),   
    legend.position="bottom",
    legend.background = element_rect(fill="white")) + # Change legend box background color
  scale_fill_brewer(palette="Set1")
  
all_cytokines_patch <- plot_all_cytokines + plot_annotation (
  title = 'Cytokine expression',
   subtitle = 'All cytokines measured',
  tag_levels = 'A',
  caption = 'CON = Water, AB = Antibiotics, BF = Breast-Feeding, FF = Formula-Feeding',
  theme = theme(plot.title = element_text(hjust = 0.5, size=14, face="bold"),
                plot.subtitle = element_text(hjust = 0.5, face = "bold.italic"),
                plot.caption = element_text(hjust = 0.5, size=7,face = "bold")))
  
#all_cytokines_patch
#ggsave('../../Results/Round 1/All Cytokines-boxplot.png',all_cytokines_patch)
```

Cytokine levels are shown below:

```{r echo=FALSE}
all_cytokines_patch
```

Distributions were assessed for normality with Shapiro-Wilk Normality Test (see table below), and plot of data were made to assess distributions visually:

```{r echo=FALSE, fig.cap='Table of test results:'}
normality_result_1
```

Most measured cytokines wore not normally disrtibuted. Consider logtransformation

```{r Normality plot, echo=FALSE, fig.cap='Non-normally distributed plots'}
normality_plot
```

```{r}
#tbl1_p contains cytokines with significant changes
tbl1_p <- tbl1 %>% 
  filter_p() %>% 
  as_tibble()

signif_cytokines <- cytokines_1_long %>%
  filter(cytokines %in% tbl1_p$Cytokines) %>%  #Exclude any cytokines not wanted in the plot
ggplot(aes(x = group, 
           y = cytokine_concentration, 
           fill = group)) + 
  geom_boxplot() +
  stat_compare_means(aes(label = ..p.signif..),
                   method = "wilcox.test", ref.group = "CON-BF",
                   label.y.npc = 0.55) +
  stat_compare_means(
    aes(label = paste0("Kruskal-Wallis \n p = ", ..p.format..)),
    label.y.npc = 0.9,
    label.x.npc = 0.5) +
  facet_wrap(~cytokines, 
             scales = 'free', 
             nrow = 3,
             ncol = 3) +
  labs(title = "Levels of pro-inflammatory cytokines in the ileum", # Change title, and axis names
       #subtitle = "Statistically significant changes", 
       x = "",
       y = "Tissue conc. (pg/mg)",
       fill = "Groups") +
  theme_bw()+
  theme(                   # Change the appearance of labels
    plot.title = element_text(color="darkgrey", size=12, face="bold"),
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.title = element_text(face="bold"),   
    legend.position="bottom",
    legend.background = element_rect(fill="white")) + # Change legend box background color
  scale_fill_brewer(palette="Set1")
  
signif_cytokines_patch <- signif_cytokines + plot_annotation (
  title = 'Cytokine expression',
  subtitle = 'Statistically significant changes',
  tag_levels = 'A',
  caption = 'CON = Water, AB = Antibiotics, BF = Breast-Feeding, FF = Formula-Feeding. \n
  Pairwise comparisons with CON-BF using wilcoxon test',
  theme = theme(plot.title = element_text(hjust = 0.5, size=14, face="bold"),
                plot.subtitle = element_text(hjust = 0.5, face = "bold.italic"),
                plot.caption = element_text(hjust = 0.5, size=7,face = "bold")))
#signif_cytokines_patch
#ggsave('../../Results/Round 1/Significant Cytokines-boxplot.png',signif_cytokines_patch)
```

The cytokines that were significantly different between groups are shown below:

```{r, echo= FALSE}
signif_cytokines_patch
```

The plot above shows that the cytokines significantly affected / difference were `r tbl1_p$Cytokines`.

A linear regression analysis calculates the factors responsible for the changes observed.

```{r echo=FALSE, warning=FALSE}
#### Make regression model on long format
reg_mod_cyt_1 <- cytokines_1_long %>% 
  group_by(cytokines) %>% 
  do(lm(data = ., cytokine_concentration ~ maternal_treatment*type_of_feed) %>% tidy)  %>% filter(term!='(Intercept)') %>% 
  ungroup() %>% 
  filter(p.value < 0.05)
```

```{r echo=FALSE, warning=FALSE}
reg_mod_cyt_1 %>% 
  select(-statistic) %>% 
  knitr::kable(., caption = 'Significant effectors on cytokine expression', digits = 5)

ff_affected_cytokines <- reg_mod_cyt_1 %>% 
  filter(term %in% "type_of_feedFF") %>% 
  pull(cytokines)

ff_affected_cytokines_pvals <- reg_mod_cyt_1 %>% 
  filter(term %in% "type_of_feedFF") %>% 
  pull(p.value)
```

Formula-feeding looks to be the most determining factor for changes to cytokine expression.

**The conclusion** is that many of the cytokines show an interaction effect of the two treatment parameters.

#### Summary of PreExp 1

-   We could keep them alive with proper feeding technique.

-   Formula feeding looks to be the most determining factor for `r ff_affected_cytokines` (p-values `r ff_affected_cytokines_pvals`, respectively).



### PreExp 2 - Selectively targeting gram+ or gram- bacteria

#### **Rationale** 
- Based on the results from Preexp 1 we knew that we could perform the experimental setup without too many casualties. 
- We had seen that formula-feeding did affect the expression of cytokines, but visual inspection of the intestines showed that we had not managed to create a NEC-like phenotype. 
- After considering the results we realized that our assumptions were based on a dysbiotics microbiome in the mother leading to less immunizing milk. However, we had likely not created a dysbiosis as much as an overall depletion by administering a broad-spectered antibiotic. 
We therefore hypothezised that targeting specific stains of bacteria would lead to a more dysbiotic microbiome and allow for greater disbiosis in the offspring. 

- In **PreExp 2** we therefore tested whether selectively targeting gram+ or gram- bacteria would lead to different and more pronounced NEC-like symptoms. 

#### Research questions: 
##### Will selectively targering gram+ or gram- bacteria with Vancomycin and Gentamicin respectively lead to more pronounced NEC-like symptoms compared with no treatment on the background of breastfeeding.




### Experiment 4 (NEC-FvT)

The PreExps are now over and it is time to conduct the study. Having determined the optimal experimental protocol in PreExp 1-3 we are ready with the design.

#### Overview - Experimental Setup

#### Intestinal permeability - FITC

```{r FITC load data, include=FALSE}
fitc <- read_excel("data/processed/fitc.xlsx") %>% 
  rename(values = `result_µg/ml_undiluted`) %>% 
  drop_na(values)
```

Intestinal permeability is assessed with the FITC-Dextran assay. First I inspect the distribution of results.

```{r FITC check for normality}
fitc %>% 
  filter(exp_number == 4) %>% 
  group_by(group) %>% 
  shapiro_test(values)
```

As results and highly skewed I try transforming the FITC results to log10.

```{r FITC try log transforming data}
fitc <- fitc %>% 
  mutate(log_10_values = log10(values))  # Logtransform results

```

```{r FITC check for normality log transform}
fitc %>% 
  filter(exp_number == 4) %>% 
  group_by(group) %>% 
  shapiro_test(log_10_values)
```

```{r FITC visual inspections of data distribution}
#Density plots non-log
density <- fitc %>% 
  filter(exp_number == 4) %>% 
  ggplot(aes(x = values, fill = group)) + 
  geom_density() +
  facet_wrap(~ group,
             scales = "free")

#Jitter plots non-log
jitter <- fitc %>% 
  filter(exp_number == 4) %>% 
  ggplot(aes(x = group, y = values)) + 
  geom_jitter() +
  facet_wrap(~ group,
             scales = "free")

#Density plots log
density <- fitc %>% 
  filter(exp_number == 4) %>% 
  ggplot(aes(x = , fill = group)) + 
  geom_density() +
  facet_wrap(~ group,
             scales = "free")

#Jitter plots non-log
jitter <- fitc %>% 
  filter(exp_number == 4) %>% 
  ggplot(aes(x = group, y = values)) + 
  geom_jitter() +
  facet_wrap(~ group,
             scales = "free") 

```

