---
title: "Gene expression"
author: "Kaare D. Tranaes"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
library(readxl)
library(tidyverse)
library(broom)
library(ggpubr)
library(AICcmodavg)
library(visdat)
library(rstatix)
library(gt)
library(gtsummary)
library(patchwork)
```

# Gene expression in Matrinem Experiment 4


```{r}
delta_gene_expr <- read_excel("data/processed/gene_expression_fold_changes.xlsx") %>%
   mutate(
    groups = recode_factor(  #Change the order of the groups to desired plot order
      groups,
      "con-bf"= "VANCO-BF",
      "sm-form" = "VANCO-SM",
      "fvt-form" = "VANCO-FVF"
      
      ))
```

## Increased
```{r increased}
increased <- delta_gene_expr %>% 
 group_by(genes, groups) %>% 
  summarise(mean_fold_change = mean(relative_fold_change)) %>% 
  filter(mean_fold_change >= 1.75)
```

## Increased plot 
```{r increased plot}
increased_plot <- delta_gene_expr %>% 
  filter(genes %in% increased$genes) %>% 
  mutate(across(genes, factor, levels=c("TNFa","MUC1","IL1b","REG3G"))) %>%
  group_by(genes, groups) %>% 
  summarise(mean_fold_change = mean(relative_fold_change)) %>% 
  ggplot(
    aes(x = groups,
        y = mean_fold_change,
        fill = groups)
  ) + 
  geom_col() +
  facet_wrap(~genes,
             nrow = 1, 
             scales = "free") + 
  labs(
       y = "Fold Δ",
       x = "",
       fill = "Groups") +
  theme_bw()+
  theme(                   
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.position = "none") + 
    scale_fill_brewer(palette="Set1")
  increased_plot
```

## Decreased
```{r decreased}
decreased <- delta_gene_expr %>% 
 group_by(genes, groups) %>% 
  summarise(mean_fold_change = mean(relative_fold_change)) %>% 
  filter(mean_fold_change < 0.6) 
  
```

## Decreased plot
```{r decreased plot}
decreased_plot <- delta_gene_expr %>% 
  filter(genes %in% decreased$genes) %>% 
  #mutate(across(genes, factor, levels=c("MUC1","IL1b","REG3G"))) %>%
  group_by(genes, groups) %>% 
  summarise(mean_fold_change = mean(relative_fold_change)) %>% 
  ggplot(
    aes(x = groups,
        y = mean_fold_change,
        fill = groups)
  ) + 
  geom_col() +
  facet_wrap(~genes,
             nrow = 1, 
             scales = "free") + 
  labs(
       y = "Fold Δ",
       x = "",
       fill = "Groups") +
  theme_bw()+
  theme(                   
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.position = "none") + 
    scale_fill_brewer(palette="Set1")
decreased_plot
```

## No change 
```{r no change}
no_change <- delta_gene_expr %>% 
  filter(!genes %in% c(increased$genes, decreased$genes))
```

## No change plot 
```{r plot}
no_change_plot <- no_change %>% 
  group_by(genes, groups) %>% 
  summarise(mean_fold_change = mean(relative_fold_change)) %>% 
  ggplot(
    aes(x = groups,
        y = mean_fold_change,
        fill = groups)
  ) + 
  geom_col() +
  facet_wrap(~genes,
             nrow = 1, 
             scales = "free") +
  labs(
       y = "Fold Δ",
       x = "",
       fill = "Groups") +
  theme_bw()+
  theme(                   # Change the appearance of labels
    plot.title = element_text(color="darkgrey", size=12, face="bold"),
    axis.title.y = element_text(color="darkgrey", size=10, face="bold.italic"),
    axis.ticks.x = element_blank(),  # Hide labels
    axis.text.x = element_blank(),
    legend.title = element_text(face="bold"),   
    legend.position="bottom",
    legend.background = element_rect(fill="lightgrey"),
    plot.caption = element_text(color = "darkgrey", size=5)) + 
  scale_fill_brewer(palette="Set1")
```

## Patchwork
```{r}
in_de_no_patch <- (decreased_plot + increased_plot) / no_change_plot + plot_annotation(
  title = "Gene expression relative fold change",
  tag_levels = "A",
  tag_suffix = ')',
  caption = "A) Decreased relative expression.     B) Increased relative expression.     C) No change in gene expression."
) & 
  theme(plot.tag = element_text(size = 12),
        plot.caption = element_text(face = "bold"))
in_de_no_patch


```


